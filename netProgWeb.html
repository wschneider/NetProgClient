<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Will^2 Chat Client</title>
<style type="text/css">
/*body 
{
    height: 100%;
}*/
#head p {
	font-weight: bold;
	font-variant: normal;
	font-size: 18px;
}
#container {
	border: thin solid #000;
	position: absolute;
	height: 90%;
	width: 90%;
}
#container #chatTable tr td #typeBox form textarea {
	width: 95%;
}
#container #chatTable {
	display:none;
}

#chatTable 
{
    width: 100%;
    height: 100%;
}

#chatTable td
{
    border: 1px solid black;
}

#privBox #chat_mario {
	
}
#privBox {
	top: 1000px;
	overflow: scroll;
	position: relative;
	bottom: 0px;
}
.userColor01
{color: #006600;}
.userColor02
{color: #006699;}
.userColor03
{color: #0000CC;}
.userColor04
{color: #00FF00;}
.userColor05
{color: #33CCFF;}
.userColor06
{color: #666600;}
.userColor07
{color: #666666;}
.userColor08
{color: #660099;}
.userColor09
{color: #990000;}
.userColor10
{color: #9933FF;}
.userColor11
{color: #CC6600;}
.userColor12
{color: #CC6699;}
.userColor13
{color: #FF3333;}
.userColor14
{color: #FF00FF;}
.userColor15
{color: #FFCC00;}
.userColor16
{color: #99FF66;}

</style>
<script>
  var url = "";
  var sock = null;
  var uid = "";
  var meisConfirmed = false;
  var mainChatContents = "";
  var users = new Object(); // Format: userChatContents[username] = [html contents of chat div]
  var activeChat = "";                 // Empty string for main chat
  users["SampleUser1"] = { privateChatContents: "Sample user 1 chat text",
                           colorClass: "userColor01"};
  users["SampleUser2"] = { privateChatContents: "Sample user 2 chat text",
                           colorClass: "userColor02"};
  users["SampleUser3"] = { privateChatContents: "Sample user 3 chat text",
                           colorClass: "userColor03"};
  var userColorArray = ["userColor01", "userColor02", "userColor03",
         "userColor04", "userColor05", "userColor06", "userColor07",
         "userColor08", "userColor09", "userColor10", "userColor11",
         "userColor12", "userColor13", "userColor14", "userColor15",
         "userColor16"]
  var nextColorIndex = 0;

  var log = function( s )
  {
	//General Purpose Logging: push string into buffer
	log.buffer.push(s);	
	console.log(s);
  }
  log.buffer = [];
  
  var handleLogin = function()
  {
	  //Login Reads the authentication info, validates, and connects to the chatserver
	  console.log("TESTING LOGIN FUNCTIONALITY");
	  
	  var urlbox = document.getElementById("urlAuth");
	  url = urlbox.value;
	  var uidbox = document.getElementById("uidAuth");
	  uid = uidbox.value;
	  
	  sock = new WebSocket(url);
	  sock.onopen = function()
  	  {
	    // ON SOCKET OPEN: log connection establishment
	    a = new Date();
	    log("" + a.toLocaleString() + ": CONNECTION ESTABLISHED"); 
		
		sock.send("ME IS " + uid);
	    
  	  }
  
  	  sock.onclose = function( e )
      {
	    a = new Date();
	    log("" + a.toLocaleString() + ": CONNECTION TERMINATED");  
      }
  
  	  sock.onerror = function( e )
      {
	    a = new Date();
	    log("" + a.toLocaleString() + ": ERROR DETECTED: \n" + e.toString());
      }
  
      sock.onmessage = function( e )
      {
	    a = new Date();
	    msg = e.data.toString()
	    log("" + a.toLocaleString() + ": MSG RECEIVED: \n" + msg);
	    parseAndHandle( msg );
      }
	  
	  //Ping the Server with a ME IS request

  }

  var parseAndHandle = function (msg) {
      //Handler function for inputted messages 
      //Messages Received:
      /*
      ME IS <fromusr>: 
      3  "OK"
      4	"ERROR"
      WHO HERE <from-usr>: 
      5 "<usr1>,<usr2>,<usr3>\n"
      4	"ERROR"
      SEND <from-usr> <to-usr>
      2  "PRIVATE FROM <from-usr>\n<CONTENTS>"
      4	"ERROR"
      BROADCAST <from-usr>\n:
      1  "BROADCAST FROM <from-usr>\n<CONTENTS>"
      4	"ERROR"
      */
      // TO DO: Logic to determine which kind of message this is and how to properly handle
      if (msg.search("BROADCAST FROM") == 0) {
          handleBroadcastIN(msg);
          return;
      }
      if (msg.search("PRIVATE FROM") == 0) {
          handlePrivateIN(msg);
          return;
      }
      if (msg.search("OK") == 0) {
          // more logic?
          if (!meisConfirmed) {
              // If the ME IS message hasn't received a response yet, then upon
              // OK, set everything up. If it has, why would we recieve OK?
              meisConfirmed = true;
              document.getElementById("chatTable").style.display = "table";
              document.getElementById("authenticationBox").style.display = "none";
              var a = document.createTextNode("You are posting as: " + uid);
              document.getElementById("uidCont").innerHTML = "";
              document.getElementById("uidCont").appendChild(a);
          }
          return;
      }
      if (msg.search("ERROR") == 0) {
          // more logic?
          // For the moment, I think we're fine just alerting users.
          // If the error is to a ME IS, the absence of OK will mean it won't go to chat.
          alert(msg);
          return;
      }
      else {
          handleWhoHereIN(msg);
          return;
      }

  }

  var handleBroadcastIN = function (msg) {
      /*
      BROADCAST FIELD FORMAT EXAMPLE:
      <p class="user_mario" onclick="privChat(mario)">&lt;mario:&gt;</p> <p> MESSAGE FROM MARIO </p>
      */
      if (activeChat == "") {
          // The main broadcast chat is currently open. Do not add alert, just display in the chat div and add the message to the main chat string too.
      }
      else {
          // The main broadcast chat is not currently open.
          // First, add an alert to the user box.
          mainChatLink = document.getElementById("mainChatLink");
          userBox.innerHTML = "Main Chat (!)";
          // TODO: Then add the message contents to the saved main chat.
      }
  }
  
  var handlePrivateIN = function( msg )
  {
	// TO DO: check for existence of private chat box. Create it if it doesnt exist. 
	//"PRIVATE FROM <from-usr>\n<CONTENTS>"
	lines   = msg.split("\n");
	first   = lines[0];
	fromuid = first.split(" ")[2];
	restmsg = msg.substring(first.length+1,msg.length-1);
	
	
	
  }

  var handleWhoHereIN = function (msg) {
      //TO DO: parse user names, format properly, and place HTML into userbox  
      names = msg.split(",");
      ubox = document.getElementById("userBox");
      ubox.innerHTML = "";
      newusers = new Object();
      for (var i = 0; i < names.length; i += 1) {

          if (users[names[i]] === undefined) {
              newusers[names[i]] = { privateChatContents: "", userColorClass: userColorArray[nextColorIndex] };
              nextColorIndex = (nextColorIndex + 1) % 16;
          }
          else {
              newusers[names[i]] = users[names[i]];
          }

          var newp = document.createElement("p");
          var newc = document.createTextNode(names[i]);
          newp.appendChild(newc);
          newp.className = newusers[names[i]].userColorClass;
          newp.setAttribute("onclick", "switchChatContext(names[i])" );
          ubox.appendChild(newp);

      }
  }

  var sendMessage = function () {
      // generate and send broadcast and send messages to server.
      var messageText = document.getElementById("mainChatTextBox").value;
      var fullMessage;
      if (activeChat == "") {
          fullMessage = "BROADCAST\n" + messageText;
      }
      else {
          fullMessage = "SEND " + activeChat + "\n" + messageText;
          var chatdisplayline = "<p><span class=\"" + users[uid].colorClass +
                  "\">" + uid + "</span>" + messageText + "</p>";
          // Also adds the sent message to the visible chat display and the
          // saved private chat memory. Not necessary for Broadcase because
          // Broadcast sends to all users including self.
          messageBox.innerHTML += chatdisplayline;
          users[activeChat].privateChatContents += chatdisplayline;
      }
      sock.send(fullMessage);
      // alert(fullMessage);
      document.getElementById("mainChatTextBox").value = "";
  }

  var switchChatContext = function (user) {
      // TO DO: remove alert notifications from user list!
      if (user === undefined) {
          document.getElementById("messageBox").innerHTML = mainChatContents;
          return;
      }
      document.getElementById("messageBox").innerHTML = users[user].privateChatContents;

  }
  
  if(this.MozWebSocket)
  {
	WebSocket = MozWebSocket;  
  }
  
  if(!window.WebSocket)
  {
	alert("WebSocket is not available in this browser. This chat client will not work");  
  }
  
  //TODO: General Purpose Changes to URL
  url = "ws://173.68.177.154:8787/chat";
  sock = new WebSocket( url );
  // TO SET: sock.onclose, sock.onerror, sock.onmessage, sock.onopen
 
  window.onload = function()
  {
	  
	  
  }

</script>
</head>
<body>
<div id="head" align="center">
  <p> Welcome to WillxWill chat client! </p>
</div>
<div id="container">
  <div id="authenticationBox" align="center">
    <p> AUTH GOES HERE </p>
    <form id="authForm">
      <table width="100%" border="1">
        <tr>
          <td>Please Enter the URL of the Chat Server:</td>
          <td><input name="input" type="text" value="ws://173.68.177.154:8787/chat" size="35" maxlength="50" id="urlAuth" /></td>
        </tr>
        <tr>
          <td>Please Select a User Name:</td>
          <td><input name="" type="text" value="LadyGaga" size="35" maxlength="25" id="uidAuth" /></td>
        </tr>
        <tr>
          <td colspan="2"><input name="Login" type="button" value="Log In" onclick="handleLogin()"/></td>
        </tr>
      </table>
    </form>
  </div>
  <table id="chatTable">
    <tr>
      <th height="5%" colspan="2" scope="col"> <div id="chatHead">
          <p id="uidCont"> CHAT HEAD </p>
          <input type="button" name="Logout" value="Log Out" onclick=("handleLogout()"/>
        </div>
      </th>
    </tr>
    <tr>
      <td width="75%"><div id="messageBox"> </div></td>
      <td width="25%" height="85%" rowspan="2"><div id="userBox">
          <p class="mainChatLink" id="mainChatLink" onclick="switchChatContext()">Main Chat</p>
          <p class="userColor01" onclick="switchChatContext(&quot;SampleUser1&quot;)">SampleUser1</p>
          <p class="userColor02" onclick="switchChatContext(&quot;SampleUser2&quot;)">SampleUser2</p>
          <p class="userColor03" onclick="switchChatContext(&quot;SampleUser3&quot;)">SampleUser3</p>
          <p> USERS BOX </p>
        </div></td>
    </tr>
    <tr>
      <td height="20%"><div id="typeBox">
          <form action="" method="get">
            <input type="file" />
            <textarea id="mainChatTextBox" rows="5" cols = "50"></textarea>
            <input name="Send Message" type="button" value="Send Message" onclick="sendMessage()" />
          </form>
        </div></td>
    </tr>
  </table>
</div>
<div id="privBox">
  <div id="chat_mario">
  <table width="10%" border="1">
    <tr>
      <td class="privHead">Private Chat with Mario</td>
    </tr>
    <tr>
      <td class="privBody">&nbsp;</td>
    </tr>
    <tr>
      <td class="privSend">
      	<form>
          <input name="PrivMsg" type="text" />
          <input name="PrivSend" type="button" value="Send Message" />
        </form>
      </td>
    </tr>
  </table>
  
  </div>

</div>

</body>
</html>
