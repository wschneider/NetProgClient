<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Will^2 Chat Client</title>
<style type="text/css">
/*body 
{
    height: 100%;
}*/
#head p {
	font-weight: bold;
	font-variant: normal;
	font-size: 18px;
}
#container {
	border: thin solid #000;
	position: absolute;
	height: 90%;
	width: 90%;
}
#container #chatTable tr td #typeBox form textarea {
	width: 95%;
}
#container #chatTable {
	display:none;
}

#chatTable 
{
    width: 100%;
    height: 100%;
}

#chatTable td
{
    border: 1px solid black;
}

#privBox #chat_mario {
	
}
#privBox {
	top: 1000px;
	overflow: scroll;
	position: relative;
	bottom: 0px;
}
</style>
<script>
  var url = "";
  var sock = null;
  var uid = "";

  var log = function( s )
  {
	//General Purpose Logging: push string into buffer
	log.buffer.push(s);
  }
  log.buffer = [];
  
  var handleLogin = function()
  {
	  //Login Reads the authentication info, validates, and connects to the chatserver
	  console.log("TESTING LOGIN FUNCTIONALITY");
	  
	  var urlbox = document.getElementById("urlAuth");
	  url = urlbox.value;
	  var uidbox = document.getElementById("uidAuth");
	  uid = uidbox.value;
	  
	  sock = new WebSocket(url);
	  sock.onopen = function()
  	  {
	    // ON SOCKET OPEN: log connection establishment
	    a = new Date();
	    log("" + a.toLocaleString() + ": CONNECTION ESTABLISHED"); 
		
		sock.send("ME IS " + uid);
	    document.getElementById("chatTable").style.display = "table";
	    document.getElementById("authenticationBox").style.display = "none";
		document.getElementById("uidCont").textContent = "You are posting as: " +  uid;
  	  }
  
  	  sock.onclose = function( e )
      {
	    a = new Date();
	    log("" + a.toLocaleString() + ": CONNECTION TERMINATED");  
      }
  
  	  sock.onerror = function( e )
      {
	    a = new Date();
	    log("" + a.toLocaleString() + ": ERROR DETECTED: \n" + e.toString());
      }
  
      sock.onmessage = function( e )
      {
	    a = new Date();
	    msg = e.data.toString()
	    log("" + a.toLocaleString() + ": MSG RECEIVED: \n" + msg);
	    parseAndHandle( msg );
      }
	  
	  //Ping the Server with a ME IS request

  }
  
  var parseAndHandle = function( msg )
  {
	//Handler function for inputted messages 
	//Messages Received:
	/*
	  ME IS <fromusr>: 
	  3  "OK"
	  4	"ERROR"
	  WHO HERE <from-usr>: 
	  5 "<usr1>,<usr2>,<usr3>\n"
	  4	"ERROR"
	  SEND <from-usr> <to-usr>
	  2  "PRIVATE FROM <from-usr>\n<CONTENTS>"
	  4	"ERROR"
	  BROADCAST <from-usr>\n:
	  1  "BROADCAST FROM <from-usr>\n<CONTENTS>"
	  4	"ERROR"
	*/
	// TO DO: Logic to determine which kind of message this is and how to properly handle
	if(msg.search("BROADCAST FROM") == 0)
	{
	  handleBroadcastIN(msg);
	  return;
	}
	if(msg.search("PRIVATE FROM") == 0)
	{
	  handlePrivateIN(msg);	
	  return;
	}
	if(msg == "OK")
	{
		// more logic?
		return;
	}
	if(msg.search("ERROR") == 0)
	{
		// more logic?
		return;	
	}
	else
	{
	  handleWhoHereIN(msg);	
	  return;
	}
	
  }
  
  var handleBroadcastIN = function( msg )
  {
	  /*
	  	BROADCAST FIELD FORMAT EXAMPLE:
			<p class="user_mario" onclick="privChat(mario)">&lt;mario:&gt;</p> <p> MESSAGE FROM MARIO </p>
	  */
	  
  }
  
  var handlePrivateIN = function( msg )
  {
	// TO DO: check for existence of private chat box. Create it if it doesnt exist. 
	//"PRIVATE FROM <from-usr>\n<CONTENTS>"
	lines   = msg.split("\n");
	first   = lines[0];
	fromuid = first.split(" ")[2];
	restmsg = msg.substring(first.length+1,msg.length-1);
	
	
	
  }
  
  var handleWhoHereIN = function( msg )
  {
	//TO DO: parse user names, format properly, and place HTML into userbox  
  }

  var broadcast = function () {
      //TO DO: generate and send broadcast message to server.
      var messageText = document.getElementById("mainChatTextBox").value;
      var fullMessage = "BROADCAST\n" + messageText;
      sock.send(fullMessage);
      alert(fullMessage);
  }
  
  if(this.MozWebSocket)
  {
	WebSocket = MozWebSocket;  
  }
  
  if(!window.WebSocket)
  {
	alert("WebSocket is not available in this browser. This chat client will not work");  
  }
  
  //TODO: General Purpose Changes to URL
  url = "ws://173.68.177.154:8787/chat";
  sock = new WebSocket( url );
  // TO SET: sock.onclose, sock.onerror, sock.onmessage, sock.onopen
 
  window.onload = function()
  {
	  
	  
  }

</script>
</head>
<body>
<div id="head" align="center">
  <p> Welcome to WillxWill chat client! </p>
</div>
<div id="container">
  <div id="authenticationBox" align="center">
    <p> AUTH GOES HERE </p>
    <form id="authForm">
      <table width="100%" border="1">
        <tr>
          <td>Please Enter the URL of the Chat Server:</td>
          <td><input name="input" type="text" value="ws://173.68.177.154:8787/chat" size="35" maxlength="50" id="urlAuth" /></td>
        </tr>
        <tr>
          <td>Please Select a User Name:</td>
          <td><input name="" type="text" value="LadyGaga" size="35" maxlength="25" id="uidAuth" /></td>
        </tr>
        <tr>
          <td colspan="2"><input name="Login" type="button" value="Log In" onclick="handleLogin()"/></td>
        </tr>
      </table>
    </form>
  </div>
  <table id="chatTable">
    <tr>
      <th height="5%" colspan="2" scope="col"> <div id="chatHead">
          <p> CHAT HEAD </p>
        </div>
      </th>
    </tr>
    <tr>
      <td width="75%"><div id="messageBox"> </div></td>
      <td width="25%" height="85%" rowspan="2"><div id="userBox">
          <p> USERS BOX </p>
        </div></td>
    </tr>
    <tr>
      <td height="20%"><div id="typeBox">
          <form action="" method="get">
            <input type="file" />
            <textarea id="mainChatTextBox" rows="5" cols = "50"></textarea>
            <input name="Send Message" type="button" value="Send Message" onclick="broadcast()" />
          </form>
        </div></td>
    </tr>
  </table>
</div>
<div id="privBox">
  <div id="chat_mario">
  <table width="10%" border="1">
    <tr>
      <td class="privHead">Private Chat with Mario</td>
    </tr>
    <tr>
      <td class="privBody">&nbsp;</td>
    </tr>
    <tr>
      <td class="privSend">
      	<form>
          <input name="PrivMsg" type="text" />
          <input name="PrivSend" type="button" value="Send Message" />
        </form>
      </td>
    </tr>
  </table>
  
  </div>

</div>

</body>
</html>
